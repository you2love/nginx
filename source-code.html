<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nginx æºç è§£è¯» - é…ç½®æ–‡ä»¶åŠ è½½ä¸è¯·æ±‚å¤„ç†</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .code-section {
            background: white;
            border-left: 4px solid #007acc;
            padding: 25px;
            margin: 25px 0;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .code-section h3 {
            color: #007acc;
            margin-top: 0;
        }
        .source-code {
            background: #263238;
            color: #aed581;
            padding: 20px;
            border-radius: 6px;
            margin: 15px 0;
            overflow-x: auto;
        }
        .source-code pre {
            margin: 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
        }
        .source-code code {
            color: #aed581;
        }
        .code-comment {
            color: #78909c;
            font-style: italic;
        }
        .code-keyword {
            color: #ff7043;
            font-weight: bold;
        }
        .code-type {
            color: #42a5f5;
        }
        .code-function {
            color: #66bb6a;
        }
        .code-string {
            color: #ffca28;
        }
        .flow-diagram {
            background: #f5f5f5;
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 6px;
            margin: 20px 0;
            font-family: monospace;
            white-space: pre;
            overflow-x: auto;
        }
        .highlight-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .note-box {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .struct-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .struct-table th, .struct-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .struct-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        .struct-table code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 13px;
        }
        .nav-link.source-code-link {
            background: #007acc;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
        }
        .nav-link.source-code-link:hover {
            background: #005a9e;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="logo">
                <h1>Nginx æ·±åº¦å­¦ä¹ </h1>
                <p class="tagline">æ­ç§˜å†…éƒ¨æœºåˆ¶ï¼ŒæŒæ¡æ ¸å¿ƒé…ç½®</p>
            </div>
            <nav class="nav">
                <a href="index.html" class="nav-link">é¦–é¡µ</a>
                <a href="mechanism.html" class="nav-link">å†…éƒ¨æœºåˆ¶</a>
                <a href="request-flow.html" class="nav-link">è¯·æ±‚å¤„ç†</a>
                <a href="directives.html" class="nav-link">æŒ‡ä»¤è¯¦è§£</a>
                <a href="configs.html" class="nav-link">åº”ç”¨é…ç½®</a>
                <a href="debug.html" class="nav-link">æ—¥å¿—è°ƒè¯•</a>
                <a href="tools.html" class="nav-link">å‘¨è¾¹å·¥å…·</a>
                <a href="modules.html" class="nav-link">æ’ä»¶ç³»ç»Ÿ</a>
                <a href="source-code.html" class="nav-link source-code-link active">æºç è§£è¯»</a>
            </nav>
        </div>
    </header>

    <main>
        <!-- æ•´ä½“æµç¨‹æ¦‚è§ˆ -->
        <section class="section">
            <div class="container">
                <h3>ğŸ“‹ æ•´ä½“æµç¨‹æ¦‚è§ˆ</h3>
                <div class="flow-diagram">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Nginx å¯åŠ¨ä¸è¯·æ±‚å¤„ç†æµç¨‹                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ã€å¯åŠ¨é˜¶æ®µã€‘                                                    â”‚
â”‚     1. main()                                                   â”‚
â”‚        â†“                                                        â”‚
â”‚     2. ngx_init_cycle()  â† åˆå§‹åŒ–å‘¨æœŸç»“æ„                        â”‚
â”‚        â†“                                                        â”‚
â”‚     3. ngx_conf_init()   â† åˆ›å»ºé…ç½®è§£æä¸Šä¸‹æ–‡                    â”‚
â”‚        â†“                                                        â”‚
â”‚     4. ngx_conf_parse()  â† è§£æé…ç½®æ–‡ä»¶                          â”‚
â”‚        â†“                                                        â”‚
â”‚     5. ngx_conf_post_configuration() â† é…ç½®åå¤„ç†               â”‚
â”‚        â†“                                                        â”‚
â”‚     6. åˆ›å»ºç›‘å¬ socketï¼Œfork worker è¿›ç¨‹                         â”‚
â”‚                                                                 â”‚
â”‚  ã€è¯·æ±‚å¤„ç†é˜¶æ®µã€‘                                                 â”‚
â”‚     1. ngx_worker_process_cycle()                               â”‚
â”‚        â†“                                                        â”‚
â”‚     2. ngx_event_loop()  â† äº‹ä»¶å¾ªç¯                              â”‚
â”‚        â†“                                                        â”‚
â”‚     3. ngx_http_process_request_line() â† è¯»å–è¯·æ±‚è¡Œ             â”‚
â”‚        â†“                                                        â”‚
â”‚     4. ngx_http_process_request_headers() â† è¯»å–è¯·æ±‚å¤´          â”‚
â”‚        â†“                                                        â”‚
â”‚     5. ngx_http_core_run_phases() â† æ‰§è¡Œ HTTP å¤„ç†é˜¶æ®µ           â”‚
â”‚        â†“                                                        â”‚
â”‚     6. æ ¹æ®é…ç½®ä¸­çš„ location åŒ¹é…ï¼Œè°ƒç”¨ç›¸åº” handler              â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                </div>
            </div>
        </section>

        <!-- ç¬¬ä¸€éƒ¨åˆ†ï¼šé…ç½®æ–‡ä»¶åŠ è½½ -->
        <section class="section">
            <div class="container">
                <h2>ä¸€ã€é…ç½®æ–‡ä»¶åŠ è½½åˆ°å†…å­˜ç»“æ„</h2>
                
                <div class="code-section">
                    <h3>1.1 æ ¸å¿ƒæ•°æ®ç»“æ„</h3>
                    <p>Nginx ä½¿ç”¨ <code>ngx_cycle_t</code> å’Œ <code>ngx_conf_t</code> ä¸¤ä¸ªæ ¸å¿ƒç»“æ„ä½“æ¥ç®¡ç†é…ç½®ï¼š</p>
                    
                    <table class="struct-table">
                        <tr>
                            <th>ç»“æ„ä½“</th>
                            <th>ä½œç”¨</th>
                            <th>å…³é”®å­—æ®µ</th>
                        </tr>
                        <tr>
                            <td><code>ngx_cycle_t</code></td>
                            <td>Nginx è¿è¡Œå‘¨æœŸç»“æ„ï¼Œä¿å­˜å…¨å±€çŠ¶æ€</td>
                            <td>
                                <code>conf_ctx</code> - æ‰€æœ‰æ¨¡å—çš„é…ç½®ä¸Šä¸‹æ–‡<br>
                                <code>pool</code> - å†…å­˜æ± <br>
                                <code>connections</code> - è¿æ¥æ•°ç»„<br>
                                <code>listening</code> - ç›‘å¬ç«¯å£æ•°ç»„
                            </td>
                        </tr>
                        <tr>
                            <td><code>ngx_conf_t</code></td>
                            <td>é…ç½®è§£æä¸Šä¸‹æ–‡</td>
                            <td>
                                <code>cycle</code> - æŒ‡å‘å½“å‰ cycle<br>
                                <code>conf_file</code> - å½“å‰è§£æçš„æ–‡ä»¶<br>
                                <code>handler</code> - é…ç½®é¡¹å¤„ç†å‡½æ•°<br>
                                <code>ctx</code> - æ¨¡å—é…ç½®ä¸Šä¸‹æ–‡
                            </td>
                        </tr>
                    </table>
                </div>

                <div class="code-section">
                    <h3>1.2 é…ç½®è§£æå…¥å£ - ngx_conf_parse()</h3>
                    <p>è¿™æ˜¯é…ç½®è§£æçš„æ ¸å¿ƒå‡½æ•°ï¼Œä½äº <code>src/core/ngx_conf_file.c</code>ï¼š</p>
                    <div class="source-code">
<pre><span class="code-comment">/* 
 * é…ç½®æ–‡ä»¶è§£æä¸»å‡½æ•°
 * cf: é…ç½®è§£æä¸Šä¸‹æ–‡
 * filename: é…ç½®æ–‡ä»¶è·¯å¾„ (å¯é€‰ï¼ŒNULL è¡¨ç¤ºä½¿ç”¨é»˜è®¤)
 */</span>
<span class="code-type">char</span> *
<span class="code-function">ngx_conf_parse</span>(ngx_conf_t *cf, ngx_str_t *filename)
{
    <span class="code-type">u_char</span>      *p;
    <span class="code-type">char</span>        *rv;
    <span class="code-type">ngx_int_t</span>    rc;
    <span class="code-type">ngx_buf_t</span>   *buf;
    <span class="code-type">ngx_str_t</span>    s;
    <span class="code-type">ngx_conf_file_t</span> *conf_file;

    <span class="code-comment">/* å¦‚æœæ˜¯é¦–æ¬¡è§£æï¼Œæ‰“å¼€é…ç½®æ–‡ä»¶ */</span>
    <span class="code-keyword">if</span> (filename) {
        cf->conf_file->file = ngx_open_file(filename->data, ...);
        <span class="code-keyword">if</span> (cf->conf_file->file == NGX_INVALID_FILE) {
            <span class="code-keyword">return</span> NGX_CONF_ERROR;
        }
    }

    <span class="code-comment">/* ä¸»è§£æå¾ªç¯ï¼šé€è¡Œè¯»å–é…ç½®æ–‡ä»¶ */</span>
    <span class="code-keyword">for</span> ( ;; ) {
        <span class="code-comment">/* è¯»å–ä¸€è¡Œé…ç½® */</span>
        rc = ngx_conf_read_token(cf);

        <span class="code-keyword">if</span> (rc == NGX_ERROR) {
            <span class="code-keyword">return</span> NGX_CONF_ERROR;
        }

        <span class="code-comment">/* è§£æå®Œæˆ */</span>
        <span class="code-keyword">if</span> (rc == NGX_DONE) {
            <span class="code-keyword">return</span> NGX_CONF_OK;
        }

        <span class="code-comment">/* å¤„ç†è§£æåˆ°çš„æŒ‡ä»¤ */</span>
        rc = ngx_conf_handler(cf, last);

        <span class="code-keyword">if</span> (rc == NGX_ERROR) {
            <span class="code-keyword">return</span> NGX_CONF_ERROR;
        }
    }
}</pre>
                    </div>
                </div>

                <div class="highlight-box">
                    <strong>å…³é”®ç‚¹ï¼š</strong>é…ç½®è§£ææ˜¯é€è¡Œè¿›è¡Œçš„ï¼Œæ¯è¡Œè¢«è§£æä¸º token åºåˆ—ï¼Œç„¶åè°ƒç”¨å¯¹åº”çš„ handler å‡½æ•°å¤„ç†ã€‚
                </div>

                <div class="code-section">
                    <h3>1.3 é…ç½®é¡¹å¤„ç† - ngx_conf_handler()</h3>
                    <p>è¯¥å‡½æ•°è´Ÿè´£æŸ¥æ‰¾å¹¶è°ƒç”¨å¯¹åº”æŒ‡ä»¤çš„å¤„ç†å‡½æ•°ï¼š</p>
                    <div class="source-code">
<pre><span class="code-keyword">static</span> <span class="code-type">ngx_int_t</span>
<span class="code-function">ngx_conf_handler</span>(ngx_conf_t *cf, ngx_int_t last)
{
    <span class="code-type">char</span>           *rv;
    <span class="code-type">void</span>           *conf, **confp;
    <span class="code-type">ngx_uint_t</span>      i, found;
    <span class="code-type">ngx_cmd_t</span>      *cmd;

    found = 0;

    <span class="code-comment">/* éå†æ‰€æœ‰æ¨¡å—çš„å‘½ä»¤ï¼ŒæŸ¥æ‰¾åŒ¹é…çš„æŒ‡ä»¤ */</span>
    <span class="code-keyword">for</span> (i = 0; cf->cycle->modules[i]; i++) {
        cmd = cf->cycle->modules[i]->commands;
        <span class="code-keyword">if</span> (cmd == NULL) {
            <span class="code-keyword">continue</span>;
        }

        <span class="code-keyword">for</span> ( ; cmd->name.len; cmd++) {
            <span class="code-comment">/* æ¯”è¾ƒæŒ‡ä»¤åç§° */</span>
            <span class="code-keyword">if</span> (cf->args->elts[0].len != cmd->name.len) {
                <span class="code-keyword">continue</span>;
            }

            <span class="code-keyword">if</span> (ngx_strcmp(cf->args->elts[0].data, cmd->name.data) != 0) {
                <span class="code-keyword">continue</span>;
            }

            found = 1;
            <span class="code-keyword">break</span>;
        }

        <span class="code-keyword">if</span> (found) {
            <span class="code-keyword">break</span>;
        }
    }

    <span class="code-comment">/* è°ƒç”¨æ‰¾åˆ°çš„å‘½ä»¤å¤„ç†å‡½æ•° */</span>
    rv = cmd->set(cmd, conf, confp, cf->args);

    <span class="code-keyword">return</span> (rv == NGX_CONF_OK) ? NGX_OK : NGX_ERROR;
}</pre>
                    </div>
                </div>

                <div class="note-box">
                    <strong>é‡è¦ï¼š</strong>æ¯ä¸ªé…ç½®æŒ‡ä»¤ï¼ˆå¦‚ <code>worker_processes</code>ã€<code>listen</code>ã€<code>root</code>ï¼‰éƒ½æœ‰å¯¹åº”çš„ <code>set</code> å‡½æ•°ï¼Œè¯¥å‡½æ•°è´Ÿè´£å°†é…ç½®å€¼å­˜å‚¨åˆ°å†…å­˜ç»“æ„ä½“ä¸­ã€‚
                </div>
            </div>
        </section>

        <!-- ç¬¬äºŒéƒ¨åˆ†ï¼šå†…å­˜ä¸­çš„é…ç½®ç»“æ„ -->
        <section class="section">
            <div class="container">
                <h2>äºŒã€é…ç½®åœ¨å†…å­˜ä¸­çš„å­˜å‚¨ç»“æ„</h2>

                <div class="code-section">
                    <h3>2.1 ä¸‰å±‚é…ç½®ç»“æ„</h3>
                    <p>Nginx HTTP æ¨¡å—çš„é…ç½®åˆ†ä¸ºä¸‰ä¸ªå±‚çº§ï¼Œæ¯ä¸ªå±‚çº§å¯¹åº”ä¸åŒçš„ç»“æ„ä½“ï¼š</p>
                    
                    <table class="struct-table">
                        <tr>
                            <th>å±‚çº§</th>
                            <th>ç»“æ„ä½“</th>
                            <th>ä½œç”¨åŸŸ</th>
                            <th>ç¤ºä¾‹æŒ‡ä»¤</th>
                        </tr>
                        <tr>
                            <td>Main</td>
                            <td><code>ngx_http_core_main_conf_t</code></td>
                            <td>å…¨å±€é…ç½®</td>
                            <td><code>worker_processes</code>, <code>user</code></td>
                        </tr>
                        <tr>
                            <td>Srv</td>
                            <td><code>ngx_http_core_srv_conf_t</code></td>
                            <td>server å—é…ç½®</td>
                            <td><code>server_name</code>, <code>listen</code></td>
                        </tr>
                        <tr>
                            <td>Loc</td>
                            <td><code>ngx_http_core_loc_conf_t</code></td>
                            <td>location å—é…ç½®</td>
                            <td><code>root</code>, <code>proxy_pass</code></td>
                        </tr>
                    </table>
                </div>

                <div class="flow-diagram">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é…ç½®å†…å­˜ç»“æ„å±‚æ¬¡å›¾                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  ngx_http_core_main_conf_t (å…¨å±€)                           â”‚
â”‚  â”œâ”€ servers: array&lt;ngx_http_core_srv_conf_t&gt;              â”‚
â”‚  â”œâ”€ phase_engine: å¤„ç†é˜¶æ®µå¼•æ“                              â”‚
â”‚  â””â”€ ...                                                    â”‚
â”‚                                                             â”‚
â”‚       â””â”€ ngx_http_core_srv_conf_t (server å—)               â”‚
â”‚          â”œâ”€ server_names: array&lt;server_name&gt;              â”‚
â”‚          â”œâ”€ locations: array&lt;ngx_http_core_loc_conf_t&gt;    â”‚
â”‚          â”œâ”€ listen: ç›‘å¬ç«¯å£é…ç½®                            â”‚
â”‚          â””â”€ ...                                            â”‚
â”‚                                                             â”‚
â”‚              â””â”€ ngx_http_core_loc_conf_t (location å—)      â”‚
â”‚                 â”œâ”€ root: æ ¹ç›®å½•è·¯å¾„                         â”‚
â”‚                 â”œâ”€ proxy_pass: ä»£ç†åœ°å€                     â”‚
â”‚                 â”œâ”€ handler: è¯·æ±‚å¤„ç†å‡½æ•°æŒ‡é’ˆ                â”‚
â”‚                 â””â”€ ...                                      â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                </div>

                <div class="code-section">
                    <h3>2.2 location é…ç½®ç¤ºä¾‹ - ngx_http_core_location()</h3>
                    <div class="source-code">
<pre><span class="code-comment">/* 
 * å¤„ç† location å—é…ç½®
 * å½“è§£æåˆ° location /xxx { ... } æ—¶è°ƒç”¨
 */</span>
<span class="code-keyword">static</span> <span class="code-type">char</span> *
<span class="code-function">ngx_http_core_location</span>(ngx_conf_t *cf, ngx_cmd_t *cmd, <span class="code-type">void</span> *conf)
{
    <span class="code-type">ngx_http_core_srv_conf_t</span>  *cscf;
    <span class="code-type">ngx_http_core_loc_conf_t</span>  *clcf, *alcf;

    cscf = ngx_http_conf_get_module_srv_conf(cf, ngx_http_core_module);

    <span class="code-comment">/* åˆ›å»º location é…ç½®ç»“æ„ */</span>
    clcf = ngx_pcalloc(cf->pool, <span class="code-keyword">sizeof</span>(ngx_http_core_loc_conf_t));
    
    <span class="code-comment">/* è§£æ location ä¿®é¥°ç¬¦å’Œè·¯å¾„ */</span>
    <span class="code-keyword">if</span> (ngx_strcmp(value[1].data, <span class="code-string">"="</span>) == 0) {
        clcf->name = value[2];
        clcf->exact_match = 1;
    } <span class="code-keyword">else</span> <span class="code-keyword">if</span> (ngx_strcmp(value[1].data, <span class="code-string">"~"</span>) == 0) {
        clcf->name = value[2];
        clcf->regex = 1;
    } <span class="code-keyword">else</span> {
        clcf->name = value[1];
    }

    <span class="code-comment">/* å°† location æ·»åŠ åˆ° server çš„ location åˆ—è¡¨ */</span>
    <span class="code-keyword">if</span> (cscf->locations == NULL) {
        cscf->locations = ngx_array_create(cf->pool, 1, 
                                           <span class="code-keyword">sizeof</span>(ngx_http_core_loc_conf_t *));
    }
    
    clcfp = ngx_array_push(cscf->locations);
    *clcfp = clcf;

    <span class="code-comment">/* é€’å½’è§£æ location å—å†…çš„é…ç½® */</span>
    rv = ngx_conf_parse(cf, NULL);

    <span class="code-keyword">return</span> rv;
}</pre>
                    </div>
                </div>
            </div>
        </section>

        <!-- ç¬¬ä¸‰éƒ¨åˆ†ï¼šè¯·æ±‚å¤„ç†ä¸­çš„é…ç½®ä½¿ç”¨ -->
        <section class="section">
            <div class="container">
                <h2>ä¸‰ã€è¯·æ±‚å¤„ç†æ—¶é…ç½®å¦‚ä½•èµ·ä½œç”¨</h2>

                <div class="code-section">
                    <h3>3.1 è¯·æ±‚å¤„ç†çš„ 11 ä¸ªé˜¶æ®µ</h3>
                    <p>HTTP è¯·æ±‚å¤„ç†åˆ†ä¸º 11 ä¸ªé˜¶æ®µï¼Œæ¯ä¸ªé˜¶æ®µéƒ½æœ‰å¯¹åº”çš„ handlerï¼Œè¿™äº› handler æ¥è‡ªé…ç½®ï¼š</p>
                    
                    <table class="struct-table">
                        <tr>
                            <th>é˜¶æ®µ</th>
                            <th>å¤„ç†å‡½æ•°</th>
                            <th>å…¸å‹ç”¨é€”</th>
                        </tr>
                        <tr>
                            <td>1. Post Read</td>
                            <td><code>ngx_http_core_post_read_phase</code></td>
                            <td>è¯·æ±‚è¯»å–åå¤„ç†</td>
                        </tr>
                        <tr>
                            <td>2. Server Rewrite</td>
                            <td><code>ngx_http_core_rewrite_phase</code></td>
                            <td>server å—é‡å†™</td>
                        </tr>
                        <tr>
                            <td>3. Find Config</td>
                            <td><code>ngx_http_core_find_config_phase</code></td>
                            <td><strong>æŸ¥æ‰¾åŒ¹é…çš„ location</strong></td>
                        </tr>
                        <tr>
                            <td>4. Rewrite</td>
                            <td><code>ngx_http_core_rewrite_phase</code></td>
                            <td>location å—é‡å†™</td>
                        </tr>
                        <tr>
                            <td>5. Post Rewrite</td>
                            <td><code>ngx_http_core_post_rewrite_phase</code></td>
                            <td>é‡å†™åå¤„ç†</td>
                        </tr>
                        <tr>
                            <td>6. Pre Access</td>
                            <td><code>ngx_http_core_pre_access_phase</code></td>
                            <td>è®¿é—®æ§åˆ¶å‰å¤„ç†</td>
                        </tr>
                        <tr>
                            <td>7. Access</td>
                            <td><code>ngx_http_core_access_phase</code></td>
                            <td><strong>è®¿é—®æƒé™æ£€æŸ¥</strong></td>
                        </tr>
                        <tr>
                            <td>8. Post Access</td>
                            <td><code>ngx_http_core_post_access_phase</code></td>
                            <td>è®¿é—®æ§åˆ¶åå¤„ç†</td>
                        </tr>
                        <tr>
                            <td>9. Try Files</td>
                            <td><code>ngx_http_core_try_files_phase</code></td>
                            <td>try_files æŒ‡ä»¤å¤„ç†</td>
                        </tr>
                        <tr>
                            <td>10. Content</td>
                            <td><code>ngx_http_core_content_phase</code></td>
                            <td><strong>ç”Ÿæˆå“åº”å†…å®¹</strong></td>
                        </tr>
                        <tr>
                            <td>11. Log</td>
                            <td><code>ngx_http_core_log_phase</code></td>
                            <td>è®°å½•è®¿é—®æ—¥å¿—</td>
                        </tr>
                    </table>
                </div>

                <div class="code-section">
                    <h3>3.2 å…³é”®ï¼šæŸ¥æ‰¾åŒ¹é…çš„ location</h3>
                    <p>åœ¨ Find Config é˜¶æ®µï¼ŒNginx æ ¹æ®è¯·æ±‚ URI æŸ¥æ‰¾åŒ¹é…çš„ location é…ç½®ï¼š</p>
                    <div class="source-code">
<pre><span class="code-comment">/* 
 * æŸ¥æ‰¾é…ç½® - ç¬¬ 3 é˜¶æ®µ
 * æ ¹æ®è¯·æ±‚ URI æ‰¾åˆ°å¯¹åº”çš„ location é…ç½®
 */</span>
<span class="code-keyword">static</span> <span class="code-type">void</span>
<span class="code-function">ngx_http_core_find_config_phase</span>(ngx_http_request_t *r,
    ngx_http_phase_handler_t *ph)
{
    <span class="code-type">u_char</span>                    *p;
    <span class="code-type">size_t</span>                     len;
    <span class="code-type">ngx_http_core_loc_conf_t</span>  *clcf;

    r->content_handler = NULL;
    r->uri_changed = 0;

    <span class="code-comment">/* æ ¸å¿ƒï¼šæ ¹æ® URI æŸ¥æ‰¾åŒ¹é…çš„ location */</span>
    clcf = ngx_http_core_find_location(r);

    r->loc_conf = clcf->loc_conf;

    <span class="code-comment">/* æ£€æŸ¥è¯·æ±‚æ–¹æ³•æ˜¯å¦å…è®¸ */</span>
    <span class="code-keyword">if</span> ((r->method & clcf->limit_except) == 0) {
        r->main->count++;
        ngx_http_internal_redirect(r, clcf->name, NULL);
        <span class="code-keyword">return</span>;
    }

    <span class="code-comment">/* è®¾ç½®å†…å®¹å¤„ç† handler */</span>
    r->content_handler = clcf->handler;

    ph++;
    r->phase_handler = ph - r->phase_engine.handlers;
    r->write_event_handler(r);
}</pre>
                    </div>
                </div>

                <div class="highlight-box">
                    <strong>å…³é”®ç‚¹ï¼š</strong><code>ngx_http_core_find_location()</code> å‡½æ•°ä¼šéå† server å—ä¸‹çš„æ‰€æœ‰ locationï¼Œæ ¹æ®åŒ¹é…è§„åˆ™ï¼ˆç²¾ç¡®åŒ¹é…ã€å‰ç¼€åŒ¹é…ã€æ­£åˆ™åŒ¹é…ï¼‰æ‰¾åˆ°æœ€åˆé€‚çš„ location é…ç½®ã€‚
                </div>

                <div class="code-section">
                    <h3>3.3 å†…å®¹ç”Ÿæˆé˜¶æ®µ - é…ç½®ä¸­çš„ handler å¦‚ä½•è¢«è°ƒç”¨</h3>
                    <div class="source-code">
<pre><span class="code-comment">/* 
 * å†…å®¹ç”Ÿæˆé˜¶æ®µ - ç¬¬ 10 é˜¶æ®µ
 * è°ƒç”¨ location é…ç½®ä¸­è®¾ç½®çš„ handler ç”Ÿæˆå“åº”
 */</span>
<span class="code-keyword">static</span> <span class="code-type">void</span>
<span class="code-function">ngx_http_core_content_phase</span>(ngx_http_request_t *r,
    ngx_http_phase_handler_t *ph)
{
    <span class="code-type">size_t</span>     root;
    <span class="code-type">ngx_int_t</span>  rc;
    <span class="code-type">ngx_http_core_loc_conf_t</span>  *clcf;

    clcf = ngx_http_get_module_loc_conf(r, ngx_http_core_module);

    <span class="code-comment">/* å¦‚æœ location è®¾ç½®äº† handlerï¼Œç›´æ¥è°ƒç”¨ */</span>
    <span class="code-keyword">if</span> (r->content_handler) {
        r->write_event_handler = ngx_http_request_empty_handler;
        rc = r->content_handler(r);
        <span class="code-keyword">return</span>;
    }

    <span class="code-comment">/* æ²¡æœ‰ handler æ—¶ï¼Œå°è¯•ä½œä¸ºé™æ€æ–‡ä»¶å¤„ç† */</span>
    <span class="code-keyword">if</span> (clcf->root.len == 0) {
        ngx_http_finalize_request(r, NGX_HTTP_NOT_FOUND);
        <span class="code-keyword">return</span>;
    }

    <span class="code-comment">/* æ‹¼æ¥æ–‡ä»¶è·¯å¾„å¹¶è¿”å›æ–‡ä»¶å†…å®¹ */</span>
    rc = ngx_http_map_uri_to_path(r, &path, &root, 0);
    <span class="code-keyword">if</span> (rc == NGX_ERROR) {
        ngx_http_finalize_request(r, NGX_HTTP_INTERNAL_SERVER_ERROR);
        <span class="code-keyword">return</span>;
    }

    ngx_http_finalize_request(r, ngx_http_static_handler(r));
}</pre>
                    </div>
                </div>

                <div class="note-box">
                    <strong>handler çš„æ¥æºï¼š</strong>ä¸åŒçš„æ¨¡å—ä¼šæ³¨å†Œä¸åŒçš„ handlerã€‚ä¾‹å¦‚ï¼š
                    <ul>
                        <li><code>proxy_pass</code> â†’ <code>ngx_http_proxy_handler</code></li>
                        <li><code>fastcgi_pass</code> â†’ <code>ngx_http_fastcgi_handler</code></li>
                        <li><code>return</code> â†’ <code>ngx_http_return_handler</code></li>
                        <li>æ— ç‰¹æ®ŠæŒ‡ä»¤ â†’ é™æ€æ–‡ä»¶å¤„ç†</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- ç¬¬å››éƒ¨åˆ†ï¼šå®Œæ•´ç¤ºä¾‹ -->
        <section class="section">
            <div class="container">
                <h2>å››ã€å®Œæ•´ç¤ºä¾‹ï¼šä»é…ç½®åˆ°ä»£ç æ‰§è¡Œ</h2>

                <div class="code-section">
                    <h3>4.1 é…ç½®ç¤ºä¾‹</h3>
                    <div class="source-code">
<pre><span class="code-comment"># nginx.conf</span>
http {
    server {
        listen 80;
        server_name example.com;
        
        <span class="code-comment"># location 1: é™æ€æ–‡ä»¶</span>
        location /static/ {
            root /var/www;
        }
        
        <span class="code-comment"># location 2: åå‘ä»£ç†</span>
        location /api/ {
            proxy_pass http://backend:8080;
        }
        
        <span class="code-comment"># location 3: ç²¾ç¡®åŒ¹é…</span>
        location = /health {
            return 200 <span class="code-string">"OK"</span>;
        }
    }
}</pre>
                    </div>
                </div>

                <div class="flow-diagram">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é…ç½®è§£æä¸å†…å­˜ç»“æ„å¯¹åº”å…³ç³»                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  é…ç½®æ–‡ä»¶                    å†…å­˜ç»“æ„                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ server {     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ ngx_http_core_srv_conf_t    â”‚    â”‚
â”‚  â”‚   listen 80; â”‚           â”‚   â”œâ”€ port = 80              â”‚    â”‚
â”‚  â”‚   ...        â”‚           â”‚   â”œâ”€ server_name = ...      â”‚    â”‚
â”‚  â”‚              â”‚           â”‚   â””â”€ locations[] = [...]    â”‚    â”‚
â”‚  â”‚ location     â”‚           â”‚         â”‚                   â”‚    â”‚
â”‚  â”‚ /static/ {   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚         â”œâ”€[0]â”€â–¶ clcf:       â”‚    â”‚
â”‚  â”‚   root       â”‚           â”‚              â”œâ”€ name = "/static/"  â”‚
â”‚  â”‚   /var/www;  â”‚           â”‚              â”œâ”€ root = "/var/www"  â”‚
â”‚  â”‚ }            â”‚           â”‚              â””â”€ handler = static   â”‚
â”‚  â”‚              â”‚           â”‚         â”‚                   â”‚    â”‚
â”‚  â”‚ location     â”‚           â”‚         â”œâ”€[1]â”€â–¶ clcf:       â”‚    â”‚
â”‚  â”‚ /api/ {      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚              â”œâ”€ name = "/api/"     â”‚
â”‚  â”‚   proxy_pass â”‚           â”‚              â””â”€ handler = proxy    â”‚
â”‚  â”‚   ...;       â”‚           â”‚         â”‚                   â”‚    â”‚
â”‚  â”‚ }            â”‚           â”‚         â””â”€[2]â”€â–¶ clcf:       â”‚    â”‚
â”‚  â”‚              â”‚           â”‚              â”œâ”€ name = "/health"   â”‚
â”‚  â”‚ location     â”‚           â”‚              â”œâ”€ exact_match = 1    â”‚
â”‚  â”‚ = /health {  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚              â””â”€ handler = return   â”‚
â”‚  â”‚   return 200 â”‚           â”‚                             â”‚    â”‚
â”‚  â”‚   "OK";      â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â”‚ }            â”‚                                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                              â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                </div>

                <div class="code-section">
                    <h3>4.2 è¯·æ±‚å¤„ç†æµç¨‹ç¤ºä¾‹</h3>
                    <p>å½“è¯·æ±‚ <code>GET /api/users</code> åˆ°è¾¾æ—¶ï¼š</p>
                    
                    <table class="struct-table">
                        <tr>
                            <th>æ­¥éª¤</th>
                            <th>å‡½æ•°</th>
                            <th>æ“ä½œ</th>
                        </tr>
                        <tr>
                            <td>1</td>
                            <td><code>ngx_http_process_request_line()</code></td>
                            <td>è§£æè¯·æ±‚è¡Œï¼Œå¾—åˆ° <code>GET /api/users HTTP/1.1</code></td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td><code>ngx_http_process_request_headers()</code></td>
                            <td>è§£æè¯·æ±‚å¤´</td>
                        </tr>
                        <tr>
                            <td>3</td>
                            <td><code>ngx_http_core_find_config_phase()</code></td>
                            <td>æŸ¥æ‰¾åŒ¹é…çš„ location â†’ æ‰¾åˆ° <code>/api/</code></td>
                        </tr>
                        <tr>
                            <td>4</td>
                            <td><code>ngx_http_core_access_phase()</code></td>
                            <td>æ‰§è¡Œè®¿é—®æ§åˆ¶æ£€æŸ¥</td>
                        </tr>
                        <tr>
                            <td>5</td>
                            <td><code>ngx_http_core_content_phase()</code></td>
                            <td>è°ƒç”¨ <code>proxy_handler</code> å¤„ç†è¯·æ±‚</td>
                        </tr>
                        <tr>
                            <td>6</td>
                            <td><code>ngx_http_proxy_handler()</code></td>
                            <td>å‘åç«¯ <code>http://backend:8080/api/users</code> è½¬å‘è¯·æ±‚</td>
                        </tr>
                    </table>
                </div>
            </div>
        </section>

        <!-- ç¬¬äº”éƒ¨åˆ†ï¼šå…³é”®æºç æ–‡ä»¶ç´¢å¼• -->
        <section class="section">
            <div class="container">
                <h2>äº”ã€å…³é”®æºç æ–‡ä»¶ç´¢å¼•</h2>
                
                <table class="struct-table">
                    <tr>
                        <th>æ–‡ä»¶è·¯å¾„</th>
                        <th>ä½œç”¨</th>
                        <th>å…³é”®å‡½æ•°</th>
                    </tr>
                    <tr>
                        <td><code>src/core/ngx_conf_file.c</code></td>
                        <td>é…ç½®æ–‡ä»¶è§£ææ ¸å¿ƒ</td>
                        <td><code>ngx_conf_parse()</code>, <code>ngx_conf_handler()</code></td>
                    </tr>
                    <tr>
                        <td><code>src/core/ngx_cycle.c</code></td>
                        <td>è¿è¡Œå‘¨æœŸç®¡ç†</td>
                        <td><code>ngx_init_cycle()</code></td>
                    </tr>
                    <tr>
                        <td><code>src/http/ngx_http_core_module.c</code></td>
                        <td>HTTP æ ¸å¿ƒæ¨¡å—</td>
                        <td><code>ngx_http_core_location()</code>, <code>ngx_http_core_find_location()</code></td>
                    </tr>
                    <tr>
                        <td><code>src/http/ngx_http_request.c</code></td>
                        <td>è¯·æ±‚å¤„ç†</td>
                        <td><code>ngx_http_process_request()</code>, <code>ngx_http_core_run_phases()</code></td>
                    </tr>
                    <tr>
                        <td><code>src/http/ngx_http_core_module.h</code></td>
                        <td>HTTP æ ¸å¿ƒç»“æ„å®šä¹‰</td>
                        <td><code>ngx_http_core_loc_conf_t</code>, <code>ngx_http_phase_t</code></td>
                    </tr>
                </table>
            </div>
        </section>

        <section class="section bg-light">
            <div class="container">
                <h3>ğŸ’¡ å­¦ä¹ å»ºè®®</h3>
                <ul style="line-height: 2;">
                    <li>é˜…è¯»æºç æ—¶ï¼Œå»ºè®®ä» <code>ngx_conf_parse()</code> å…¥æ‰‹ï¼Œç†è§£é…ç½®è§£ææµç¨‹</li>
                    <li>é‡ç‚¹å…³æ³¨é…ç½®å€¼å¦‚ä½•å­˜å‚¨åˆ°ç»“æ„ä½“ä¸­ï¼Œä»¥åŠåœ¨è¯·æ±‚å¤„ç†æ—¶å¦‚ä½•è¢«è¯»å–ä½¿ç”¨</li>
                    <li>ä½¿ç”¨ GDB æˆ–æ‰“å°æ—¥å¿—è·Ÿè¸ªå…³é”®å‡½æ•°çš„æ‰§è¡Œè·¯å¾„</li>
                    <li>ç»“åˆ Nginx æºç ä¸­çš„æ³¨é‡Šï¼ˆè‹±æ–‡æ³¨é‡Šé€šå¸¸æ›´è¯¦ç»†ï¼‰ä¸€èµ·é˜…è¯»</li>
                </ul>
            </div>
        </section>
    </main>
</body>
</html>
