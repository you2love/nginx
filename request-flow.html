<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nginx è¯·æ±‚å¤„ç†æµç¨‹ - å®Œæ•´ç”Ÿå‘½å‘¨æœŸ</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .flow-container {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 8px;
            margin: 20px 0;
            overflow-x: auto;
        }
        .flow-diagram {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }
        .flow-box {
            background: white;
            border: 2px solid #007acc;
            border-radius: 8px;
            padding: 15px;
            min-width: 140px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .flow-box.phase {
            background: #e3f2fd;
            border-color: #1976d2;
        }
        .flow-box.action {
            background: #fff3e0;
            border-color: #f57c00;
        }
        .flow-box.decision {
            background: #fce4ec;
            border-color: #c2185b;
            border-radius: 50%;
            width: 100px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .flow-arrow {
            color: #666;
            font-size: 24px;
        }
        .phase-detail {
            background: white;
            border-left: 4px solid #007acc;
            padding: 20px;
            margin: 20px 0;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .phase-detail h4 {
            color: #007acc;
            margin-top: 0;
        }
        .phase-number {
            display: inline-block;
            background: #007acc;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            margin-right: 10px;
        }
        .directive-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 10px 0;
        }
        .directive-tag {
            background: #f4f4f4;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 14px;
            border: 1px solid #ddd;
        }
        .directive-tag code {
            background: transparent;
            padding: 0;
        }
        .sequence-diagram {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            overflow-x: auto;
        }
        .sequence-diagram pre {
            margin: 0;
            font-size: 13px;
            line-height: 1.6;
        }
        .note-box {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .info-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .info-table th, .info-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .info-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        .info-table code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="logo">
                <h1>Nginx æ·±åº¦å­¦ä¹ </h1>
                <p class="tagline">æ­ç§˜å†…éƒ¨æœºåˆ¶ï¼ŒæŒæ¡æ ¸å¿ƒé…ç½®</p>
            </div>
            <nav class="nav">
                <a href="index.html" class="nav-link">é¦–é¡µ</a>
                <a href="mechanism.html" class="nav-link">å†…éƒ¨æœºåˆ¶</a>
                <a href="request-flow.html" class="nav-link active">è¯·æ±‚å¤„ç†</a>
                <a href="directives.html" class="nav-link">æŒ‡ä»¤è¯¦è§£</a>
                <a href="configs.html" class="nav-link">åº”ç”¨é…ç½®</a>
                <a href="debug.html" class="nav-link">æ—¥å¿—è°ƒè¯•</a>
                <a href="tools.html" class="nav-link">å‘¨è¾¹å·¥å…·</a>
                <a href="modules.html" class="nav-link">æ’ä»¶ç³»ç»Ÿ</a>
            </nav>
        </div>
    </header>

    <main>
        <section class="section">
            <div class="container">
                <h2 class="section-title">ğŸ“Š è¯·æ±‚å¤„ç†æµç¨‹å›¾</h2>
                
                <div class="flow-container">
                    <div class="flow-diagram">
                        <div class="flow-box action">
                            <strong>å®¢æˆ·ç«¯è¯·æ±‚</strong>
                            <br><small>HTTP Request</small>
                        </div>
                        <div class="flow-arrow">â†’</div>
                        <div class="flow-box phase">
                            <strong>1. POST_READ</strong>
                            <br><small>è¯»å–è¯·æ±‚</small>
                        </div>
                        <div class="flow-arrow">â†’</div>
                        <div class="flow-box phase">
                            <strong>2. SERVER_REWRITE</strong>
                            <br><small>Server çº§é‡å†™</small>
                        </div>
                        <div class="flow-arrow">â†’</div>
                        <div class="flow-box decision">
                            <strong>3. FIND_CONFIG</strong>
                            <br><small>æŸ¥æ‰¾ Location</small>
                        </div>
                        <div class="flow-arrow">â†’</div>
                        <div class="flow-box phase">
                            <strong>4. REWRITE</strong>
                            <br><small>Location çº§é‡å†™</small>
                        </div>
                        <div class="flow-arrow">â†’</div>
                        <div class="flow-box phase">
                            <strong>5. POST_REWRITE</strong>
                            <br><small>é‡å†™åæ£€æŸ¥</small>
                        </div>
                        <div class="flow-arrow">â†’</div>
                        <div class="flow-box phase">
                            <strong>6. PREACCESS</strong>
                            <br><small>è®¿é—®å‰å¤„ç†</small>
                        </div>
                        <div class="flow-arrow">â†’</div>
                        <div class="flow-box phase">
                            <strong>7. ACCESS</strong>
                            <br><small>è®¿é—®æ§åˆ¶</small>
                        </div>
                        <div class="flow-arrow">â†’</div>
                        <div class="flow-box phase">
                            <strong>8. POST_ACCESS</strong>
                            <br><small>è®¿é—®åå¤„ç†</small>
                        </div>
                        <div class="flow-arrow">â†’</div>
                        <div class="flow-box phase">
                            <strong>9. TRY_FILES</strong>
                            <br><small>æ–‡ä»¶æ£€æŸ¥</small>
                        </div>
                        <div class="flow-arrow">â†’</div>
                        <div class="flow-box phase">
                            <strong>10. CONTENT</strong>
                            <br><small>å†…å®¹ç”Ÿæˆ</small>
                        </div>
                        <div class="flow-arrow">â†’</div>
                        <div class="flow-box phase">
                            <strong>11. LOG</strong>
                            <br><small>æ—¥å¿—è®°å½•</small>
                        </div>
                        <div class="flow-arrow">â†’</div>
                        <div class="flow-box action">
                            <strong>å“åº”è¿”å›</strong>
                            <br><small>HTTP Response</small>
                        </div>
                    </div>
                </div>

                <div class="note-box">
                    <strong>ğŸ’¡ è¯´æ˜ï¼š</strong> è¯·æ±‚æŒ‰ç…§ä»ä¸Šåˆ°ä¸‹çš„é¡ºåºä¾æ¬¡ç»è¿‡ 11 ä¸ªå¤„ç†é˜¶æ®µï¼Œæ¯ä¸ªé˜¶æ®µå¯èƒ½æœ‰å¤šä¸ªæ¨¡å—æ³¨å†Œçš„å¤„ç†å‡½æ•°ã€‚é˜¶æ®µä¹‹é—´å¯ä»¥è·³è½¬æˆ–ç»ˆæ­¢ã€‚
                </div>
            </div>
        </section>

        <section class="section">
            <div class="container">
                <h2 class="section-title">ğŸ”„ è¯·æ±‚å¤„ç†åºåˆ—å›¾</h2>
                
                <div class="sequence-diagram">
                    <pre>
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client â”‚     â”‚ Nginx   â”‚     â”‚ Location â”‚     â”‚ Backend â”‚     â”‚  Log   â”‚
â”‚        â”‚     â”‚ Core    â”‚     â”‚ Matcher  â”‚     â”‚ Server  â”‚     â”‚        â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
    â”‚                â”‚                â”‚                â”‚             â”‚
    â”‚ HTTP Request   â”‚                â”‚                â”‚             â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚                â”‚             â”‚
    â”‚                â”‚                â”‚                â”‚             â”‚
    â”‚                â”‚ POST_READ      â”‚                â”‚             â”‚
    â”‚                â”‚ (realip ç­‰)    â”‚                â”‚             â”‚
    â”‚                â”‚                â”‚                â”‚             â”‚
    â”‚                â”‚ SERVER_REWRITE â”‚                â”‚             â”‚
    â”‚                â”‚ (server rewrite)               â”‚             â”‚
    â”‚                â”‚                â”‚                â”‚             â”‚
    â”‚                â”‚ FIND_CONFIG â”€â”€>â”‚                â”‚             â”‚
    â”‚                â”‚ (åŒ¹é… location) â”‚                â”‚             â”‚
    â”‚                â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚             â”‚
    â”‚                â”‚                â”‚                â”‚             â”‚
    â”‚                â”‚ REWRITE        â”‚                â”‚             â”‚
    â”‚                â”‚ (location rewrite)             â”‚             â”‚
    â”‚                â”‚                â”‚                â”‚             â”‚
    â”‚                â”‚ POST_REWRITE   â”‚                â”‚             â”‚
    â”‚                â”‚ (é‡å†™æ£€æŸ¥)      â”‚                â”‚             â”‚
    â”‚                â”‚                â”‚                â”‚             â”‚
    â”‚                â”‚ PREACCESS      â”‚                â”‚             â”‚
    â”‚                â”‚ (limit_req ç­‰) â”‚                â”‚             â”‚
    â”‚                â”‚                â”‚                â”‚             â”‚
    â”‚                â”‚ ACCESS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚             â”‚
    â”‚                â”‚ (allow/deny)   â”‚                â”‚             â”‚
    â”‚                â”‚                â”‚                â”‚             â”‚
    â”‚                â”‚ POST_ACCESS    â”‚                â”‚             â”‚
    â”‚                â”‚                â”‚                â”‚             â”‚
    â”‚                â”‚ TRY_FILES      â”‚                â”‚             â”‚
    â”‚                â”‚ (æ–‡ä»¶æ£€æŸ¥)      â”‚                â”‚             â”‚
    â”‚                â”‚                â”‚                â”‚             â”‚
    â”‚                â”‚ CONTENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚             â”‚
    â”‚                â”‚ (proxy_pass/   â”‚                â”‚             â”‚
    â”‚                â”‚  fastcgi_pass) â”‚                â”‚             â”‚
    â”‚                â”‚                â”‚                â”‚             â”‚
    â”‚                â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚             â”‚
    â”‚                â”‚                â”‚                â”‚ Response    â”‚
    â”‚                â”‚                â”‚                â”‚             â”‚
    â”‚                â”‚                â”‚                â”‚             â”‚
    â”‚                â”‚ LOG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                â”‚ (access_log)   â”‚                â”‚             â”‚
    â”‚                â”‚                â”‚                â”‚             â”‚
    â”‚ HTTP Response  â”‚                â”‚                â”‚             â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚                â”‚             â”‚
    â”‚                â”‚                â”‚                â”‚             â”‚
                    </pre>
                </div>
            </div>
        </section>

        <section class="section">
            <div class="container">
                <h2 class="section-title">ğŸ“‹ 11 ä¸ªå¤„ç†é˜¶æ®µè¯¦è§£</h2>

                <div class="phase-detail">
                    <h4><span class="phase-number">1</span>NGX_HTTP_POST_READ_PHASE - è¯»å–è¯·æ±‚åé˜¶æ®µ</h4>
                    <p><strong>è¯´æ˜ï¼š</strong> è¯·æ±‚è¢«å®Œæ•´è¯»å–åçš„ç¬¬ä¸€ä¸ªå¤„ç†é˜¶æ®µï¼Œé€šå¸¸ç”¨äºä¿®æ”¹è¯·æ±‚å¤´æˆ–è®°å½•è¯·æ±‚ä¿¡æ¯ã€‚</p>
                    <p><strong>å¸¸ç”¨æŒ‡ä»¤ï¼š</strong></p>
                    <div class="directive-list">
                        <span class="directive-tag"><code>real_ip_header</code></span>
                        <span class="directive-tag"><code>set_real_ip_from</code></span>
                        <span class="directive-tag"><code>real_ip_recursive</code></span>
                        <span class="directive-tag"><code>mirror</code></span>
                    </div>
                    <p><strong>å…¸å‹åº”ç”¨ï¼š</strong></p>
                    <ul>
                        <li>è·å–å®¢æˆ·ç«¯çœŸå® IPï¼ˆé€šè¿‡ X-Forwarded-For ç­‰å¤´ï¼‰</li>
                        <li>è¯·æ±‚é•œåƒï¼ˆæµé‡å¤åˆ¶ï¼‰</li>
                        <li>è¯·æ±‚å¤´ä¿®æ”¹</li>
                    </ul>
                    <div class="highlight-box">
                        <pre>
# è·å–çœŸå® IP
set_real_ip_from 10.0.0.0/8;
real_ip_header X-Forwarded-For;
real_ip_recursive on;</pre>
                    </div>
                </div>

                <div class="phase-detail">
                    <h4><span class="phase-number">2</span>NGX_HTTP_SERVER_REWRITE_PHASE - Server çº§é‡å†™é˜¶æ®µ</h4>
                    <p><strong>è¯´æ˜ï¼š</strong> åœ¨ server å—ä¸­æ‰§è¡Œçš„ URL é‡å†™ï¼Œæ­¤æ—¶å°šæœªç¡®å®š locationã€‚</p>
                    <p><strong>å¸¸ç”¨æŒ‡ä»¤ï¼š</strong></p>
                    <div class="directive-list">
                        <span class="directive-tag"><code>rewrite</code></span>
                        <span class="directive-tag"><code>return</code></span>
                        <span class="directive-tag"><code>set</code></span>
                        <span class="directive-tag"><code>if</code></span>
                    </div>
                    <p><strong>å…¸å‹åº”ç”¨ï¼š</strong></p>
                    <ul>
                        <li>HTTP å¼ºåˆ¶è·³è½¬ HTTPS</li>
                        <li>åŸŸåé‡å®šå‘</li>
                        <li>URL è§„èŒƒåŒ–</li>
                        <li>æ—§ URL é‡å®šå‘åˆ°æ–° URL</li>
                    </ul>
                    <div class="highlight-box">
                        <pre>
server {
    listen 80;
    server_name example.com;
    
    # HTTP å¼ºåˆ¶è·³è½¬ HTTPS
    return 301 https://$host$request_uri;
    
    # æ—§ URL é‡å®šå‘
    rewrite ^/old/(.*)$ /new/$1 permanent;
}</pre>
                    </div>
                </div>

                <div class="phase-detail">
                    <h4><span class="phase-number">3</span>NGX_HTTP_FIND_CONFIG_PHASE - æŸ¥æ‰¾é…ç½®é˜¶æ®µ</h4>
                    <p><strong>è¯´æ˜ï¼š</strong> æ ¹æ®è¯·æ±‚ URI æŸ¥æ‰¾åŒ¹é…çš„ location é…ç½®ã€‚æ­¤é˜¶æ®µ Nginx å†…éƒ¨å¤„ç†ï¼Œæ— æ³•ç›´æ¥å¹²é¢„ã€‚</p>
                    <p><strong>åŒ¹é…ä¼˜å…ˆçº§ï¼š</strong></p>
                    <ol>
                        <li><code>= /path</code> - ç²¾ç¡®åŒ¹é…ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰</li>
                        <li><code>^~ /path</code> - å‰ç¼€åŒ¹é…ï¼Œåœæ­¢æ­£åˆ™æœç´¢</li>
                        <li><code>~ pattern</code> - æ­£åˆ™åŒ¹é…ï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰</li>
                        <li><code>~* pattern</code> - æ­£åˆ™åŒ¹é…ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰</li>
                        <li><code>/path</code> - æ™®é€šå‰ç¼€åŒ¹é…ï¼ˆä¼˜å…ˆçº§æœ€ä½ï¼‰</li>
                    </ol>
                    <div class="warning-box">
                        <strong>âš ï¸ æ³¨æ„ï¼š</strong> æ­¤é˜¶æ®µæ˜¯ Nginx å†…éƒ¨å¤„ç†ï¼Œä¸æ‰§è¡Œä»»ä½•æ¨¡å— handlerï¼Œä»…ç¡®å®šä½¿ç”¨å“ªä¸ª location é…ç½®ã€‚
                    </div>
                </div>

                <div class="phase-detail">
                    <h4><span class="phase-number">4</span>NGX_HTTP_REWRITE_PHASE - Location çº§é‡å†™é˜¶æ®µ</h4>
                    <p><strong>è¯´æ˜ï¼š</strong> åœ¨ location å—ä¸­æ‰§è¡Œçš„ URL é‡å†™ã€‚</p>
                    <p><strong>å¸¸ç”¨æŒ‡ä»¤ï¼š</strong></p>
                    <div class="directive-list">
                        <span class="directive-tag"><code>rewrite</code></span>
                        <span class="directive-tag"><code>return</code></span>
                        <span class="directive-tag"><code>set</code></span>
                        <span class="directive-tag"><code>if</code></span>
                        <span class="directive-tag"><code>break</code></span>
                    </div>
                    <p><strong>å…¸å‹åº”ç”¨ï¼š</strong></p>
                    <ul>
                        <li>URL é‡å†™ï¼ˆä¼ªé™æ€ï¼‰</li>
                        <li>æ¡ä»¶é‡å®šå‘</li>
                        <li>å˜é‡è®¾ç½®</li>
                    </ul>
                    <div class="highlight-box">
                        <pre>
location /blog/ {
    # ä¼ªé™æ€ï¼šå°† /blog/123 é‡å†™ä¸º /blog.php?id=123
    rewrite ^/blog/([0-9]+)$ /blog.php?id=$1 last;
    
    # æ¡ä»¶åˆ¤æ–­
    if ($request_method = POST) {
        return 403;
    }
}</pre>
                    </div>
                </div>

                <div class="phase-detail">
                    <h4><span class="phase-number">5</span>NGX_HTTP_POST_REWRITE_PHASE - é‡å†™åæ£€æŸ¥é˜¶æ®µ</h4>
                    <p><strong>è¯´æ˜ï¼š</strong> æ£€æŸ¥ rewrite æ˜¯å¦å¯¼è‡´ URI å˜åŒ–ï¼Œå¦‚æœå˜åŒ–åˆ™é‡æ–°è¿›å…¥ FIND_CONFIG é˜¶æ®µã€‚</p>
                    <p><strong>å¸¸ç”¨æŒ‡ä»¤ï¼š</strong> æ— ï¼ˆå†…éƒ¨å¤„ç†é˜¶æ®µï¼‰</p>
                    <div class="warning-box">
                        <strong>âš ï¸ æ³¨æ„ï¼š</strong> å¦‚æœ rewrite ä½¿ç”¨äº† <code>last</code> æˆ– <code>redirect</code>/<code>permanent</code>ï¼Œä¼šé‡æ–°è¿›å…¥ location åŒ¹é…æµç¨‹ï¼Œå¯èƒ½å¯¼è‡´å¾ªç¯ã€‚
                    </div>
                </div>

                <div class="phase-detail">
                    <h4><span class="phase-number">6</span>NGX_HTTP_PREACCESS_PHASE - è®¿é—®æ§åˆ¶å‰é˜¶æ®µ</h4>
                    <p><strong>è¯´æ˜ï¼š</strong> åœ¨è¿›è¡Œè®¿é—®æ§åˆ¶æ£€æŸ¥ä¹‹å‰çš„é¢„å¤„ç†é˜¶æ®µã€‚</p>
                    <p><strong>å¸¸ç”¨æŒ‡ä»¤ï¼š</strong></p>
                    <div class="directive-list">
                        <span class="directive-tag"><code>limit_req_zone</code></span>
                        <span class="directive-tag"><code>limit_conn_zone</code></span>
                        <span class="directive-tag"><code>limit_req</code></span>
                        <span class="directive-tag"><code>limit_conn</code></span>
                        <span class="directive-tag"><code>add_header</code></span>
                    </div>
                    <p><strong>å…¸å‹åº”ç”¨ï¼š</strong></p>
                    <ul>
                        <li>è¯·æ±‚é€Ÿç‡é™åˆ¶</li>
                        <li>è¿æ¥æ•°é™åˆ¶</li>
                        <li>æ·»åŠ å®‰å…¨å“åº”å¤´</li>
                    </ul>
                    <div class="highlight-box">
                        <pre>
# å®šä¹‰é™æµåŒºåŸŸ
limit_req_zone $binary_remote_addr zone=one:10m rate=10r/s;

# åº”ç”¨é™æµ
location /api/ {
    limit_req zone=one burst=20 nodelay;
    proxy_pass http://backend;
}</pre>
                    </div>
                </div>

                <div class="phase-detail">
                    <h4><span class="phase-number">7</span>NGX_HTTP_ACCESS_PHASE - è®¿é—®æ§åˆ¶é˜¶æ®µ</h4>
                    <p><strong>è¯´æ˜ï¼š</strong> æ‰§è¡Œè®¿é—®æ§åˆ¶æ£€æŸ¥ï¼Œå†³å®šè¯·æ±‚æ˜¯å¦è¢«å…è®¸ã€‚</p>
                    <p><strong>å¸¸ç”¨æŒ‡ä»¤ï¼š</strong></p>
                    <div class="directive-list">
                        <span class="directive-tag"><code>allow</code></span>
                        <span class="directive-tag"><code>deny</code></span>
                        <span class="directive-tag"><code>auth_basic</code></span>
                        <span class="directive-tag"><code>auth_basic_user_file</code></span>
                        <span class="directive-tag"><code>auth_request</code></span>
                    </div>
                    <p><strong>å…¸å‹åº”ç”¨ï¼š</strong></p>
                    <ul>
                        <li>IP é»‘ç™½åå•</li>
                        <li>HTTP åŸºæœ¬è®¤è¯</li>
                        <li>å­è¯·æ±‚è®¤è¯</li>
                    </ul>
                    <div class="highlight-box">
                        <pre>
location /admin/ {
    # IP è®¿é—®æ§åˆ¶
    allow 192.168.1.0/24;
    deny all;
    
    # åŸºæœ¬è®¤è¯
    auth_basic "Admin Area";
    auth_basic_user_file /etc/nginx/.htpasswd;
}</pre>
                    </div>
                </div>

                <div class="phase-detail">
                    <h4><span class="phase-number">8</span>NGX_HTTP_POST_ACCESS_PHASE - è®¿é—®æ§åˆ¶åé˜¶æ®µ</h4>
                    <p><strong>è¯´æ˜ï¼š</strong> è®¿é—®æ§åˆ¶æ£€æŸ¥åçš„å¤„ç†é˜¶æ®µï¼Œç”¨äºæ»¡è¶³ post_action æŒ‡ä»¤çš„éœ€æ±‚ã€‚</p>
                    <p><strong>å¸¸ç”¨æŒ‡ä»¤ï¼š</strong></p>
                    <div class="directive-list">
                        <span class="directive-tag"><code>post_action</code></span>
                    </div>
                    <p><strong>å…¸å‹åº”ç”¨ï¼š</strong></p>
                    <ul>
                        <li>è¯·æ±‚åå¤„ç†ï¼ˆå¦‚ç»Ÿè®¡ã€é€šçŸ¥ï¼‰</li>
                    </ul>
                    <div class="warning-box">
                        <strong>âš ï¸ æ³¨æ„ï¼š</strong> post_action åœ¨ä¸»è¯·æ±‚å®Œæˆåæ‰§è¡Œï¼Œé€šå¸¸ç”¨äºåå°å¤„ç†ä»»åŠ¡ã€‚
                    </div>
                </div>

                <div class="phase-detail">
                    <h4><span class="phase-number">9</span>NGX_HTTP_TRY_FILES_PHASE - æ–‡ä»¶æ£€æŸ¥é˜¶æ®µ</h4>
                    <p><strong>è¯´æ˜ï¼š</strong> å¤„ç† try_files æŒ‡ä»¤ï¼ŒæŒ‰é¡ºåºæ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ã€‚</p>
                    <p><strong>å¸¸ç”¨æŒ‡ä»¤ï¼š</strong></p>
                    <div class="directive-list">
                        <span class="directive-tag"><code>try_files</code></span>
                    </div>
                    <p><strong>å…¸å‹åº”ç”¨ï¼š</strong></p>
                    <ul>
                        <li>SPA åº”ç”¨è·¯ç”±æ”¯æŒ</li>
                        <li>é™æ€æ–‡ä»¶å›é€€</li>
                        <li>è‡ªå®šä¹‰ 404 å¤„ç†</li>
                    </ul>
                    <div class="highlight-box">
                        <pre>
# SPA åº”ç”¨é…ç½®
location / {
    try_files $uri $uri/ /index.html;
}

# é™æ€æ–‡ä»¶æœåŠ¡
location /files/ {
    try_files $uri $uri/ =404;
}</pre>
                    </div>
                </div>

                <div class="phase-detail">
                    <h4><span class="phase-number">10</span>NGX_HTTP_CONTENT_PHASE - å†…å®¹ç”Ÿæˆé˜¶æ®µ</h4>
                    <p><strong>è¯´æ˜ï¼š</strong> ç”Ÿæˆå“åº”å†…å®¹çš„æ ¸å¿ƒé˜¶æ®µï¼Œå¤šä¸ªæ¨¡å—å¯ä»¥æ³¨å†Œ handlerã€‚</p>
                    <p><strong>å¸¸ç”¨æŒ‡ä»¤ï¼š</strong></p>
                    <div class="directive-list">
                        <span class="directive-tag"><code>proxy_pass</code></span>
                        <span class="directive-tag"><code>fastcgi_pass</code></span>
                        <span class="directive-tag"><code>uwsgi_pass</code></span>
                        <span class="directive-tag"><code>scgi_pass</code></span>
                        <span class="directive-tag"><code>grpc_pass</code></span>
                        <span class="directive-tag"><code>return</code></span>
                        <span class="directive-tag"><code>root</code></span>
                        <span class="directive-tag"><code>alias</code></span>
                        <span class="directive-tag"><code>index</code></span>
                        <span class="directive-tag"><code>autoindex</code></span>
                        <span class="directive-tag"><code>stub_status</code></span>
                        <span class="directive-tag"><code>echo</code></span>
                    </div>
                    <p><strong>å…¸å‹åº”ç”¨ï¼š</strong></p>
                    <ul>
                        <li>åå‘ä»£ç†</li>
                        <li>FastCGI/PHP å¤„ç†</li>
                        <li>é™æ€æ–‡ä»¶æœåŠ¡</li>
                        <li>ç›®å½•åˆ—è¡¨</li>
                        <li>å¥åº·æ£€æŸ¥</li>
                    </ul>
                    <div class="highlight-box">
                        <pre>
# åå‘ä»£ç†
location /api/ {
    proxy_pass http://backend:8080;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
}

# é™æ€æ–‡ä»¶æœåŠ¡
location /static/ {
    root /var/www;
    expires 30d;
    gzip on;
}

# PHP å¤„ç†
location ~ \.php$ {
    fastcgi_pass 127.0.0.1:9000;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    include fastcgi_params;
}</pre>
                    </div>
                </div>

                <div class="phase-detail">
                    <h4><span class="phase-number">11</span>NGX_HTTP_LOG_PHASE - æ—¥å¿—è®°å½•é˜¶æ®µ</h4>
                    <p><strong>è¯´æ˜ï¼š</strong> è¯·æ±‚å¤„ç†å®Œæˆåçš„æ—¥å¿—è®°å½•é˜¶æ®µã€‚</p>
                    <p><strong>å¸¸ç”¨æŒ‡ä»¤ï¼š</strong></p>
                    <div class="directive-list">
                        <span class="directive-tag"><code>access_log</code></span>
                        <span class="directive-tag"><code>log_format</code></span>
                        <span class="directive-tag"><code>open_log_file_cache</code></span>
                        <span class="directive-tag"><code>log_not_found</code></span>
                        <span class="directive-tag"><code>log_subrequest</code></span>
                    </div>
                    <p><strong>å…¸å‹åº”ç”¨ï¼š</strong></p>
                    <ul>
                        <li>è®¿é—®æ—¥å¿—è®°å½•</li>
                        <li>è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼</li>
                        <li>æ—¥å¿—ç¼“å†²</li>
                    </ul>
                    <div class="highlight-box">
                        <pre>
# è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼
log_format main '$remote_addr - $remote_user [$time_local] '
                '"$request" $status $body_bytes_sent '
                '"$http_referer" "$http_user_agent" '
                '$request_time $upstream_response_time';

# åº”ç”¨æ—¥å¿—æ ¼å¼
access_log /var/log/nginx/access.log main buffer=32k flush=1m;</pre>
                    </div>
                </div>
            </div>
        </section>

        <section class="section">
            <div class="container">
                <h2 class="section-title">ğŸ“Š é˜¶æ®µä¸æŒ‡ä»¤å¯¹åº”è¡¨</h2>
                <table class="info-table">
                    <thead>
                        <tr>
                            <th>é˜¶æ®µ</th>
                            <th>é˜¶æ®µåç§°</th>
                            <th>å¸¸ç”¨æŒ‡ä»¤</th>
                            <th>æ˜¯å¦å¯è·³è¿‡</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td>POST_READ</td>
                            <td><code>real_ip_header</code>, <code>set_real_ip_from</code>, <code>mirror</code></td>
                            <td>æ˜¯</td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td>SERVER_REWRITE</td>
                            <td><code>rewrite</code>, <code>return</code>, <code>set</code></td>
                            <td>æ˜¯</td>
                        </tr>
                        <tr>
                            <td>3</td>
                            <td>FIND_CONFIG</td>
                            <td>ï¼ˆå†…éƒ¨å¤„ç†ï¼‰</td>
                            <td>å¦</td>
                        </tr>
                        <tr>
                            <td>4</td>
                            <td>REWRITE</td>
                            <td><code>rewrite</code>, <code>return</code>, <code>set</code>, <code>if</code></td>
                            <td>æ˜¯</td>
                        </tr>
                        <tr>
                            <td>5</td>
                            <td>POST_REWRITE</td>
                            <td>ï¼ˆå†…éƒ¨å¤„ç†ï¼‰</td>
                            <td>å¦</td>
                        </tr>
                        <tr>
                            <td>6</td>
                            <td>PREACCESS</td>
                            <td><code>limit_req</code>, <code>limit_conn</code></td>
                            <td>æ˜¯</td>
                        </tr>
                        <tr>
                            <td>7</td>
                            <td>ACCESS</td>
                            <td><code>allow</code>, <code>deny</code>, <code>auth_basic</code></td>
                            <td>æ˜¯</td>
                        </tr>
                        <tr>
                            <td>8</td>
                            <td>POST_ACCESS</td>
                            <td><code>post_action</code></td>
                            <td>æ˜¯</td>
                        </tr>
                        <tr>
                            <td>9</td>
                            <td>TRY_FILES</td>
                            <td><code>try_files</code></td>
                            <td>æ˜¯</td>
                        </tr>
                        <tr>
                            <td>10</td>
                            <td>CONTENT</td>
                            <td><code>proxy_pass</code>, <code>fastcgi_pass</code>, <code>root</code>, <code>return</code></td>
                            <td>å¦</td>
                        </tr>
                        <tr>
                            <td>11</td>
                            <td>LOG</td>
                            <td><code>access_log</code>, <code>log_format</code></td>
                            <td>æ˜¯</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section class="section">
            <div class="container">
                <h2 class="section-title">ğŸ’¡ è¯·æ±‚å¤„ç†ç¤ºä¾‹</h2>
                
                <div class="note-box">
                    <strong>ç¤ºä¾‹åœºæ™¯ï¼š</strong> ç”¨æˆ·è¯·æ±‚ <code>http://example.com/api/users</code>ï¼ŒNginx å¦‚ä½•å¤„ç†ï¼Ÿ
                </div>

                <div class="highlight-box">
                    <pre>
http {
    # ===== é˜¶æ®µ 1: POST_READ =====
    # è·å–çœŸå® IP
    set_real_ip_from 10.0.0.0/8;
    real_ip_header X-Forwarded-For;
    
    # ===== é˜¶æ®µ 6: PREACCESS =====
    # å®šä¹‰é™æµåŒºåŸŸ
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
    
    server {
        listen 80;
        server_name example.com;
        
        # ===== é˜¶æ®µ 2: SERVER_REWRITE =====
        # å¼ºåˆ¶ HTTPS
        if ($scheme = http) {
            return 301 https://$host$request_uri;
        }
        
        # ===== é˜¶æ®µ 7-10: å¤„ç†/api/è¯·æ±‚ =====
        location /api/ {
            # ===== é˜¶æ®µ 4: REWRITE =====
            # URL é‡å†™ï¼ˆå¦‚æœ‰éœ€è¦ï¼‰
            rewrite ^/api/v1/(.*)$ /api/$1 break;
            
            # ===== é˜¶æ®µ 6: PREACCESS =====
            # åº”ç”¨é™æµ
            limit_req zone=api_limit burst=20 nodelay;
            
            # ===== é˜¶æ®µ 7: ACCESS =====
            # IP é™åˆ¶
            allow 192.168.0.0/16;
            deny all;
            
            # ===== é˜¶æ®µ 10: CONTENT =====
            # åå‘ä»£ç†
            proxy_pass http://backend:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
        
        # ===== é˜¶æ®µ 10: CONTENT (é™æ€æ–‡ä»¶) =====
        location /static/ {
            root /var/www;
            expires 30d;
            add_header Cache-Control "public, immutable";
        }
        
        # ===== é˜¶æ®µ 9: TRY_FILES (SPA åº”ç”¨) =====
        location /app/ {
            try_files $uri $uri/ /app/index.html;
        }
        
        # ===== é˜¶æ®µ 11: LOG =====
        access_log /var/log/nginx/access.log;
    }
}</pre>
                </div>
            </div>
        </section>

        <section class="section">
            <div class="container">
                <h2 class="section-title">âš ï¸ æ³¨æ„äº‹é¡¹</h2>
                
                <div class="warning-box">
                    <strong>rewrite å¾ªç¯é—®é¢˜ï¼š</strong> ä½¿ç”¨ <code>last</code> æ ‡å¿—æ—¶ï¼Œä¼šé‡æ–°è¿›å…¥ location åŒ¹é…æµç¨‹ï¼Œå¯èƒ½å¯¼è‡´æ— é™å¾ªç¯ã€‚å»ºè®®ä½¿ç”¨ <code>break</code> æˆ–åœ¨é‡å†™åçš„ location ä¸­é¿å…å†æ¬¡åŒ¹é…ã€‚
                </div>
                
                <div class="warning-box">
                    <strong>if æŒ‡ä»¤çš„å±€é™æ€§ï¼š</strong> <code>if</code> æŒ‡ä»¤åœ¨ rewrite é˜¶æ®µæ‰§è¡Œï¼Œè¡Œä¸ºå¯èƒ½ä¸ç¬¦åˆé¢„æœŸã€‚é¿å…åœ¨ <code>if</code> ä¸­ä½¿ç”¨ <code>set</code>ã€<code>rewrite</code> ä»¥å¤–çš„æŒ‡ä»¤ã€‚
                </div>
                
                <div class="warning-box">
                    <strong>é˜¶æ®µè·³è½¬ï¼š</strong> æŸäº›æŒ‡ä»¤ä¼šå¯¼è‡´è¯·æ±‚è·³è½¬åˆ°å…¶ä»–é˜¶æ®µï¼Œå¦‚ <code>error_page</code> ä¼šåˆ›å»ºå†…éƒ¨é‡å®šå‘ï¼Œ<code>try_files</code> å¯èƒ½ç›´æ¥è¿”å› 404ã€‚
                </div>
                
                <div class="note-box">
                    <strong>æ€§èƒ½æç¤ºï¼š</strong> 
                    <ul>
                        <li>å°†å¸¸ç”¨çš„è®¿é—®æ§åˆ¶æ”¾åœ¨é å‰çš„é˜¶æ®µ</li>
                        <li>é¿å…è¿‡å¤šçš„ rewrite è§„åˆ™</li>
                        <li>ä½¿ç”¨ <code>break</code> ä»£æ›¿ <code>last</code> å‡å°‘é‡æ–°åŒ¹é…</li>
                        <li>åˆç†ä½¿ç”¨ç¼“å­˜å’Œè¿‡æœŸå¤´å‡å°‘åç«¯å‹åŠ›</li>
                    </ul>
                </div>
            </div>
        </section>
    </main>
</body>
</html>
